<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Business Hub Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .tab-active { color: #2563eb; border-bottom: 3px solid #2563eb; }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app" class="max-w-md mx-auto min-h-screen bg-white shadow-xl relative pb-24">
        
        <!-- Header -->
        <div class="bg-blue-600 p-8 text-white rounded-b-[2.5rem] shadow-lg">
            <h1 class="text-xl font-bold">Business Hub SL</h1>
            <div class="mt-6 grid grid-cols-2 gap-4">
                <div class="bg-white/20 p-4 rounded-2xl">
                    <p class="text-[10px] uppercase font-bold opacity-80">ආදායම</p>
                    <p id="totalIn" class="text-lg font-bold">රු. 0</p>
                </div>
                <div class="bg-white/20 p-4 rounded-2xl">
                    <p class="text-[10px] uppercase font-bold opacity-80">වියදම</p>
                    <p id="totalOut" class="text-lg font-bold">රු. 0</p>
                </div>
            </div>
            <div class="mt-4 bg-white text-blue-600 p-4 rounded-2xl flex justify-between items-center shadow-inner">
                <span class="font-bold">ශුද්ධ ලාභය</span>
                <span id="netProfit" class="text-xl font-bold">රු. 0</span>
            </div>
        </div>

        <!-- Content -->
        <div id="mainContent" class="p-5">
            <!-- List View -->
            <div id="listView">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">ගනුදෙනු විස්තර</h3>
                    <select id="filter" class="text-xs font-bold text-blue-600 bg-transparent outline-none">
                        <option value="All">සියලුම ශාඛා</option>
                    </select>
                </div>
                <div id="recordList" class="space-y-3">
                    <div class="text-center py-10 text-gray-300">දත්ත පූරණය වෙමින්...</div>
                </div>
            </div>

            <!-- Form View (Hidden by default) -->
            <div id="formView" class="hidden animate-in fade-in">
                <form id="entryForm" class="bg-gray-50 p-6 rounded-3xl border space-y-4">
                    <h2 class="text-lg font-bold">නව දත්තයක් එක් කරන්න</h2>
                    <select id="branchIn" class="w-full p-4 rounded-2xl border outline-none"></select>
                    <select id="typeIn" class="w-full p-4 rounded-2xl border outline-none">
                        <option value="in">ආදායම (Income)</option>
                        <option value="out">වියදම (Expense)</option>
                    </select>
                    <input id="descIn" type="text" placeholder="විස්තරය" required class="w-full p-4 rounded-2xl border outline-none">
                    <input id="amountIn" type="number" placeholder="මුදල (රු.)" required class="w-full p-4 rounded-2xl border outline-none text-xl font-bold text-blue-600">
                    <button type="submit" id="saveBtn" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-bold shadow-lg">සුරකින්න</button>
                </form>
            </div>
        </div>

        <!-- Bottom Nav -->
        <div class="fixed bottom-6 left-6 right-6 max-w-[calc(448px-3rem)] mx-auto bg-white border shadow-2xl rounded-3xl p-3 flex justify-around z-50">
            <button onclick="showTab('home')" id="homeTab" class="flex flex-col items-center p-2 tab-active">
                <i data-lucide="layout-grid" class="w-6 h-6"></i>
                <span class="text-[8px] font-bold mt-1">සාරාංශය</span>
            </button>
            <button onclick="showTab('add')" id="addTab" class="flex flex-col items-center p-2 text-gray-400">
                <i data-lucide="plus-circle" class="w-6 h-6"></i>
                <span class="text-[8px] font-bold mt-1">එක් කරන්න</span>
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const config = JSON.parse(window.__firebase_config || '{}');
        const app = initializeApp(config);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = window.__app_id || 'pieris-motors-audit-2026';

        const BRANCHES = ["පරගම්මන ශොප්", "රන්වල බයික් ශොප්", "රන්වල ත්‍රීවීල් ශොප්", "කෑගල්ල ශොප්", "හෙල්මට් ශොප්", "කෑගල්ල වර්ක් ශොප්", "පරගම්මන වර්ක් ශොප්", "කුෂන් වැඩපොළ"];

        // Init UI
        const branchSelect = document.getElementById('branchIn');
        const filterSelect = document.getElementById('filter');
        BRANCHES.forEach(b => {
            branchSelect.innerHTML += `<option value="${b}">${b}</option>`;
            filterSelect.innerHTML += `<option value="${b}">${b}</option>`;
        });
        lucide.createIcons();

        // Tabs
        window.showTab = (t) => {
            const isHome = t === 'home';
            document.getElementById('listView').classList.toggle('hidden', !isHome);
            document.getElementById('formView').classList.toggle('hidden', isHome);
            document.getElementById('homeTab').classList.toggle('tab-active', isHome);
            document.getElementById('homeTab').classList.toggle('text-gray-400', !isHome);
            document.getElementById('addTab').classList.toggle('tab-active', !isHome);
            document.getElementById('addTab').classList.toggle('text-gray-400', isHome);
        };

        // Auth & Sync
        signInAnonymously(auth);
        const col = collection(db, 'artifacts', appId, 'public', 'data', 'records');
        onSnapshot(col, (snap) => {
            const data = snap.docs.map(d => d.data()).sort((a,b) => b.t - a.t);
            render(data);
        });

        const render = (records) => {
            const fValue = filterSelect.value;
            const filtered = records.filter(r => fValue === 'All' || r.branch === fValue);
            let inc = 0, exp = 0;
            
            document.getElementById('recordList').innerHTML = filtered.map(r => {
                if(r.type === 'in') inc += r.amount; else exp += r.amount;
                return `
                    <div class="bg-white p-4 rounded-2xl border flex justify-between items-center shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="p-2 rounded-xl ${r.type === 'in' ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'}">
                                <i data-lucide="${r.type === 'in' ? 'arrow-up' : 'arrow-down'}" class="w-4 h-4"></i>
                            </div>
                            <div><p class="text-sm font-bold">${r.branch}</p><p class="text-[10px] text-gray-400">${r.desc}</p></div>
                        </div>
                        <p class="font-bold ${r.type === 'in' ? 'text-green-600' : 'text-red-600'}">රු. ${r.amount.toLocaleString()}</p>
                    </div>
                `;
            }).join('');

            document.getElementById('totalIn').innerText = 'රු. ' + inc.toLocaleString();
            document.getElementById('totalOut').innerText = 'රු. ' + exp.toLocaleString();
            document.getElementById('netProfit').innerText = 'රු. ' + (inc - exp).toLocaleString();
            lucide.createIcons();
        };

        filterSelect.onchange = () => { /* re-render handled by onSnapshot or manual call if needed */ };

        // Save
        document.getElementById('entryForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('saveBtn');
            btn.disabled = true; btn.innerText = "සුරකිමින්...";
            await addDoc(col, {
                branch: document.getElementById('branchIn').value,
                type: document.getElementById('typeIn').value,
                desc: document.getElementById('descIn').value,
                amount: parseFloat(document.getElementById('amountIn').value),
                t: Date.now()
            });
            btn.disabled = false; btn.innerText = "සුරකින්න";
            e.target.reset();
            showTab('home');
        };
    </script>
</body>
</html>
